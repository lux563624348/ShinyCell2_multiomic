# Use official Rocker Shiny image (includes R + Shiny + Shiny Server)
FROM rocker/shiny:latest

ENV DEBIAN_FRONTEND=noninteractive

# System dependencies
RUN apt-get update && apt-get install -y \
    sudo \
    wget \
    curl \
    gdebi-core \
    libcurl4-openssl-dev \
    libglpk-dev \
    libssl-dev \
    libxml2-dev \
    libhdf5-dev \
    build-essential \
    liblzma-dev \
    libgsl-dev \
    libbz2-dev \
    git \
    python3 \
    python3-pip \
    python3-venv \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Install required R packages
RUN R -e "reqPkg = c('shinyhelper','data.table','Matrix','DT','magrittr','ggplot2','ggrepel','hdf5r','ggdendro','gridExtra','ggpubr','reticulate','R.utils','glue','readr','future','RColorBrewer'); \
           newPkg = reqPkg[!(reqPkg %in% installed.packages()[,'Package'])]; \
           if(length(newPkg)) install.packages(newPkg)"

# Optional: Seurat & Signac
RUN R -e "install.packages('Seurat')"
# RUN R -e "install.packages('Signac', repos='https://cran.rstudio.com/')"

# Install devtools + ShinyCell2
RUN R -e "install.packages('devtools')"
RUN R -e "devtools::install_github('the-ouyang-lab/ShinyCell2')"

# Install BiocManager + ArchR
RUN R -e "install.packages('BiocManager')"
RUN R -e "devtools::install_github('GreenleafLab/ArchR', ref='master', repos = BiocManager::repositories())"

# Expose Shiny Server port
EXPOSE 3838

# Use the default Shiny Server entrypoint from the base image
CMD ["/usr/bin/shiny-server"]
